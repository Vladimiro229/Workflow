<!doctype html>
<html lang="uk">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Hesh Order Stage ‚Äî Mini</title>
  <style>
    :root{
      --bg:#f6f7fb;
      --card:#ffffff;
      --text:#0f172a;
      --muted:#64748b;
      --line:#e5e7eb;

      --done:#22c55e;
      --progress:#3b82f6;
      --blocked:#f59e0b;
      --rework:#ef4444;
      --todo:#94a3b8;

      --shadow: 0 10px 25px rgba(15, 23, 42, .08);
      --r:16px;
    }

    *{box-sizing:border-box}
    body{
      margin:0;
      font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Arial, "Noto Sans";
      background:var(--bg);
      color:var(--text);
    }

    .wrap{
      max-width: 1200px;
      margin: 24px auto;
      padding: 0 14px 40px;
    }

    .topbar{
      display:flex;
      gap:12px;
      align-items:center;
      justify-content:space-between;
      margin-bottom: 14px;
    }

    .brand{
      display:flex; gap:10px; align-items:center;
      font-weight:800;
      letter-spacing:.2px;
    }
    .cat{
      width:38px; height:38px; border-radius: 12px;
      display:grid; place-items:center;
      background:linear-gradient(135deg,#e2e8f0,#ffffff);
      border:1px solid var(--line);
      box-shadow: 0 6px 14px rgba(2,6,23,.06);
      font-size:20px;
    }

    .search{
      flex:1;
      display:flex;
      gap:10px;
      align-items:center;
      justify-content:flex-end;
      flex-wrap:wrap;
    }
    .input{
      display:flex; align-items:center; gap:10px;
      background:var(--card);
      border:1px solid var(--line);
      border-radius: 14px;
      padding: 10px 12px;
      box-shadow: 0 6px 14px rgba(2,6,23,.05);
      min-width: min(520px, 100%);
    }
    .input input{
      border:0; outline:0; width:100%;
      font-size:14px; background:transparent;
    }
    .btn{
      border:0;
      padding: 10px 14px;
      border-radius: 14px;
      background: linear-gradient(135deg,#2563eb,#60a5fa);
      color:white;
      font-weight:700;
      cursor:pointer;
      box-shadow: 0 10px 18px rgba(37,99,235,.22);
    }
    .btn:active{transform: translateY(1px)}
    .ghost{
      border:1px solid var(--line);
      background:var(--card);
      box-shadow: 0 6px 14px rgba(2,6,23,.05);
      color:var(--text);
    }

    .grid{
      display:grid;
      grid-template-columns: 1.6fr .9fr;
      gap: 14px;
      align-items:start;
    }
    @media (max-width: 980px){
      .grid{grid-template-columns: 1fr}
      .input{min-width:100%}
      .search{justify-content:stretch}
    }

    .card{
      background:var(--card);
      border:1px solid var(--line);
      border-radius: var(--r);
      box-shadow: var(--shadow);
    }
    .card h3{
      margin:0;
      font-size:14px;
      letter-spacing:.2px;
    }
    .card .hd{
      padding: 14px 14px 10px;
      display:flex; align-items:center; justify-content:space-between;
      border-bottom: 1px solid var(--line);
    }
    .card .bd{padding: 14px}

    .pill{
      font-size:12px;
      padding: 6px 10px;
      border-radius: 999px;
      border:1px solid var(--line);
      background:#f8fafc;
      color:var(--muted);
      font-weight:700;
      white-space:nowrap;
    }
    .pill.done{background:rgba(34,197,94,.12); border-color:rgba(34,197,94,.28); color:#15803d;}
    .pill.progress{background:rgba(59,130,246,.12); border-color:rgba(59,130,246,.28); color:#1d4ed8;}
    .pill.blocked{background:rgba(245,158,11,.14); border-color:rgba(245,158,11,.30); color:#b45309;}
    .pill.rework{background:rgba(239,68,68,.12); border-color:rgba(239,68,68,.28); color:#b91c1c;}
    .pill.todo{background:rgba(148,163,184,.12); border-color:rgba(148,163,184,.30); color:#475569;}

    .meta{
      display:flex; gap:10px; flex-wrap:wrap;
      color:var(--muted);
      font-size:13px;
      margin-top: 6px;
    }

    .progressRow{
      display:flex; align-items:center; gap:10px;
      margin-top: 10px;
    }
    .bar{
      flex:1;
      height: 10px;
      background:#eef2ff;
      border:1px solid #e0e7ff;
      border-radius:999px;
      overflow:hidden;
    }
    .bar > div{
      height:100%;
      width: 0%;
      background: linear-gradient(90deg,#2563eb,#60a5fa);
      border-radius:999px;
      transition: width .35s ease;
    }

    /* Timeline */
    .timeline{
      display:flex;
      gap:10px;
      flex-wrap:wrap;
      align-items:center;
    }
    .stage{
      display:flex;
      align-items:center;
      gap:8px;
      padding: 10px 12px;
      border-radius: 14px;
      border:1px solid var(--line);
      background:#fff;
      min-width: 170px;
      position:relative;
    }
    .dot{
      width:10px; height:10px; border-radius:999px;
      background: var(--todo);
    }
    .stage .name{
      font-weight:800; font-size:13px;
      line-height:1.1;
    }
    .stage .sub{
      font-size:12px;
      color:var(--muted);
      margin-top:2px;
    }
    .stage.active{
      border-color: rgba(59,130,246,.35);
      box-shadow: 0 10px 20px rgba(59,130,246,.12);
      outline: 2px solid rgba(59,130,246,.15);
      animation: pulse 1.4s infinite;
    }
    @keyframes pulse{
      0%,100%{outline-offset:0}
      50%{outline-offset:3px}
    }

    .stage.done .dot{background:var(--done)}
    .stage.progress .dot{background:var(--progress)}
    .stage.blocked .dot{background:var(--blocked)}
    .stage.rework .dot{background:var(--rework)}
    .stage.todo .dot{background:var(--todo)}

    /* Line items */
    .items{
      display:flex; flex-direction:column; gap:10px;
    }
    .item{
      border:1px solid var(--line);
      border-radius: 14px;
      padding: 12px;
      display:grid;
      grid-template-columns: 64px 1fr auto;
      gap: 12px;
      align-items:center;
      background:#fff;
    }
    .img{
      width:64px; height:64px;
      border-radius: 14px;
      border:1px solid var(--line);
      display:grid; place-items:center;
      background: linear-gradient(135deg,#f1f5f9,#ffffff);
      color:#334155;
      font-size:26px;
    }
    .item .title{
      font-weight:900;
      font-size:14px;
      margin:0 0 4px;
    }
    .item .desc{
      color:var(--muted);
      font-size:12px;
      display:flex; gap:10px; flex-wrap:wrap;
    }
    .item .right{
      display:flex;
      align-items:flex-end;
      flex-direction:column;
      gap:8px;
      min-width: 180px;
    }
    .miniBar{
      width: 180px;
      height: 8px;
      border-radius: 999px;
      background:#f1f5f9;
      border:1px solid #e2e8f0;
      overflow:hidden;
    }
    .miniBar > div{
      height:100%;
      width:0%;
      border-radius:999px;
      background: linear-gradient(90deg,#22c55e,#86efac);
      transition: width .35s ease;
    }
    .kv{
      display:flex; gap:10px; flex-wrap:wrap;
      font-size:12px; color:var(--muted);
    }
    .kv b{color:var(--text)}
    .muted{color:var(--muted)}
    .small{font-size:12px}

    .sideBig{
      font-size: 18px;
      font-weight: 1000;
      margin: 4px 0 6px;
      letter-spacing:.2px;
    }
    .sideHint{
      color:var(--muted);
      font-size:13px;
      margin:0;
    }
    .risk{
      margin-top: 12px;
      display:flex;
      flex-direction:column;
      gap:8px;
    }
    .risk .row{
      display:flex; gap:10px; align-items:center;
      padding: 10px 12px;
      border-radius: 14px;
      border:1px dashed var(--line);
      background:#fbfdff;
      font-size: 13px;
    }
    .risk .row strong{font-weight:900}
    .sep{height:1px;background:var(--line);margin:12px 0}
  </style>
</head>
<body>
  <div class="wrap">
    <div class="topbar">
      <div class="brand">
        <div class="cat" title="–∫–æ—Ç–∏–∫-–±—Ä–µ–Ω–¥ üê±">üê±</div>
        <div>
          <div style="font-size:14px;">Hesh</div>
          <div class="muted small">Mini: –ü–æ—à—É–∫ —Å—Ç–∞–¥—ñ—ó –∑–∞–º–æ–≤–ª–µ–Ω–Ω—è</div>
        </div>
      </div>

      <div class="search">
        <div class="input" title="–í–≤–µ–¥—ñ—Ç—å external_order_id">
          <span class="muted">üîé</span>
          <input id="q" placeholder="–ù–∞–ø—Ä.: O-AW-3918" autocomplete="off" />
        </div>
        <button class="btn" id="btnSearch">–ó–Ω–∞–π—Ç–∏</button>
        <button class="btn ghost" id="btnDemo" title="–ü–æ–∫–∞–∑–∞—Ç–∏ –¥–µ–º–æ –¥–∞–Ω—ñ">–î–µ–º–æ</button>
      </div>
    </div>

    <div class="grid">
      <!-- Left -->
      <div class="card">
        <div class="hd">
          <h3>–ó–∞–º–æ–≤–ª–µ–Ω–Ω—è</h3>
          <span id="orderStatusPill" class="pill progress">–£ —Ä–æ–±–æ—Ç—ñ</span>
        </div>
        <div class="bd">
          <div style="display:flex;align-items:flex-start;justify-content:space-between;gap:12px;flex-wrap:wrap;">
            <div>
              <div style="font-weight:1000;font-size:18px;" id="orderId">‚Äî</div>
              <div class="meta" id="orderMeta">
                <span>–°—Ç–≤–æ—Ä–µ–Ω–æ: ‚Äî</span>
                <span>–î–µ–¥–ª–∞–π–Ω: ‚Äî</span>
                <span>–ö–ª—ñ—î–Ω—Ç: ‚Äî</span>
              </div>

              <div class="progressRow">
                <div class="pill" id="syncPill">Sync: ‚Äî</div>
                <div class="bar" aria-label="progress">
                  <div id="orderProgressBar"></div>
                </div>
                <div class="muted small" id="orderProgressText">‚Äî%</div>
              </div>
            </div>

            <div style="min-width:260px;">
              <div class="muted small">–ü–æ—Ç–æ—á–Ω–∞ —Å—Ç–∞–¥—ñ—è (–ø–æ –∑–∞–º–æ–≤–ª–µ–Ω–Ω—é)</div>
              <div class="sideBig" id="orderCurrentStage">‚Äî</div>
              <div class="muted small" id="orderCurrentHint">–í–∏–∑–Ω–∞—á–∞—î—Ç—å—Å—è –∑ line_items: InProgress ‚Üí current task</div>
            </div>
          </div>

          <div class="sep"></div>

          <div style="display:flex;align-items:center;justify-content:space-between;gap:12px;flex-wrap:wrap;">
            <h3 style="margin:0;">Workflow (—Å–ø—Ä–æ—â–µ–Ω–æ)</h3>
            <div class="muted small">–ü—ñ–¥—Ç—è–≥—É—î–º–æ –≤—Å—ñ –ø—Ä–æ—Ü–µ—Å–∏, –∞–∫—Ç–∏–≤–Ω–∏–π –µ—Ç–∞–ø –ø—ñ–¥—Å–≤—ñ—á—É—î–º–æ</div>
          </div>
          <div style="margin-top:12px;" class="timeline" id="timeline"></div>

          <div class="sep"></div>

          <div style="display:flex;align-items:center;justify-content:space-between;gap:12px;flex-wrap:wrap;">
            <h3 style="margin:0;">–ü–æ–∑–∏—Ü—ñ—ó –∑–∞–º–æ–≤–ª–µ–Ω–Ω—è</h3>
            <div class="muted small" id="itemsSummary">‚Äî</div>
          </div>
          <div style="margin-top:12px;" class="items" id="items"></div>
        </div>
      </div>

      <!-- Right -->
      <div class="card">
        <div class="hd">
          <h3>–ü–∞–Ω–µ–ª—å –º–µ–Ω–µ–¥–∂–µ—Ä–∞</h3>
          <span class="pill" id="mgrBadge">–®–≤–∏–¥–∫–∏–π –æ–≥–ª—è–¥</span>
        </div>
        <div class="bd">
          <div class="muted small">–©–æ –∫–∞–∑–∞—Ç–∏ –∫–ª—ñ—î–Ω—Ç—É</div>
          <div class="sideBig" id="callout">‚Äî</div>
          <p class="sideHint" id="calloutHint">‚Äî</p>

          <div class="sep"></div>

          <div class="muted small">–°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞</div>
          <div class="kv" style="margin-top:8px;">
            <span><b id="stDone">0</b> –≤–∏–∫–æ–Ω–∞–Ω–æ</span>
            <span><b id="stProg">0</b> —É —Ä–æ–±–æ—Ç—ñ</span>
            <span><b id="stTodo">0</b> –Ω–µ —Å—Ç–∞—Ä—Ç</span>
            <span><b id="stRisk">0</b> —Ä–∏–∑–∏–∫–∏</span>
          </div>

          <div class="risk" id="risks"></div>

          <div class="sep"></div>
          <div class="muted small">–ü—ñ–¥–∫–∞–∑–∫–∞</div>
          <div class="small muted" style="margin-top:6px;">
            –£ –ø—Ä–æ–¥—ñ –∞–π—Ç—ñ—à–Ω–∏–∫ –ø—ñ–¥‚Äô—î–¥–Ω–∞—î Hesh API:<br/>
            <b>Get order</b> ‚Üí <b>Get state line_item</b> ‚Üí (–æ–ø—Ü.) <b>Get state workflow</b>.
          </div>
        </div>
      </div>
    </div>
  </div>

  <script>
    // ===== DEMO DATA (–∑–∞–º—ñ—Å—Ç—å API) =====
    // –£ —Ä–µ–∞–ª—ñ –∞–π—Ç—ñ—à–Ω–∏–∫ –ø—ñ–¥—Å—Ç–∞–≤–∏—Ç—å –¥–∞–Ω—ñ –∑ Hesh API.
    const DEMO = {
      order: {
        external_order_id: "O-AW-3918",
        customer: "–ú–∞—Ä–∏–Ω–∞ Awarder",
        created_at: "21.02.2026",
        deadline: "13.02.2026",
        sync_status: "OK", // OK / WARN / ERROR
        progress: 79,
      },
      workflowStages: [
        "–°—Ç–≤–æ—Ä–µ–Ω–Ω—è –º–∞–∫–µ—Ç—É",
        "–ö–æ–Ω—Ç—Ä–æ–ª—å –º–∞–∫–µ—Ç—É",
        "–î—Ä—É–∫ –Ω–∞ –ø–ª—ñ–≤—Ü—ñ",
        "–í–∏—Ä—ñ–∑–∞–Ω–Ω—è —Ü–∏—Ñ–µ—Ä–±–ª–∞—Ç–∞",
        "–ó–±—ñ—Ä–∫–∞ —Ü–∏—Ñ–µ—Ä–±–ª–∞—Ç–∞",
        "–ö–æ–Ω—Ç—Ä–æ–ª—å —è–∫–æ—Å—Ç—ñ —Ü–∏—Ñ–µ—Ä–±–ª–∞—Ç–∞",
        "–ó–±—ñ—Ä–∫–∞ –≥–æ–¥–∏–Ω–Ω–∏–∫–∞",
        "–ù–∞–Ω–µ—Å–µ–Ω–Ω—è –≥—Ä–∞–≤—ñ—é–≤–∞–Ω–Ω—è",
        "–ö–æ–Ω—Ç—Ä–æ–ª—å —è–∫–æ—Å—Ç—ñ –≥–æ–¥–∏–Ω–Ω–∏–∫–∞",
        "–í—ñ–¥–ø—Ä–∞–≤–∫–∞ —Ç–æ–≤–∞—Ä—É"
      ],
      // line_items –∑ "current/prev/next" —è–∫ —Ä–µ–∑—É–ª—å—Ç–∞—Ç state-–º–µ—Ç–æ–¥—ñ–≤
      line_items: [
        {
          id:"LI-1010-GREEN",
          icon:"üì¶",
          title:"–ö–æ—Ä–æ–±–æ—á–∫–∞ —Ç–∞–∫—Ç–∏—á–Ω–∞ 1010 ‚Äî —ñ–Ω–¥–∏–≤—ñ–¥—É–∞–ª—å–Ω–∏–π –¥–∏–∑–∞–π–Ω",
          sku:"1010 –ó–µ–ª–µ–Ω–∞",
          qty:1,
          tags:["–¢–ö: –õ–∞–∑–µ—Ä+–£–§"],
          status:"Done", // Done / InProgress / NotStarted / Blocked / Rework
          percent:100,
          prev:"–ó–±—ñ—Ä–∫–∞ —Ü–∏—Ñ–µ—Ä–±–ª–∞—Ç–∞",
          current:"–í—ñ–¥–ø—Ä–∞–≤–∫–∞ —Ç–æ–≤–∞—Ä—É",
          next:"‚Äî"
        },
        {
          id:"LI-AW055",
          icon:"‚åö",
          title:"Awarder 055 ‚Äî —ñ–Ω–¥–∏–≤—ñ–¥—É–∞–ª—å–Ω–∏–π –¥–∏–∑–∞–π–Ω",
          sku:"Silver-Black",
          qty:1,
          tags:["–¢–¶: –£–§+–õ–∞–∑–µ—Ä","–¢–ó: –ù–æ–≤–∏–π","–¢–®: –î–≤–æ—à–∞—Ä–æ–≤–∏–π","–ì—Ä–∞–≤—ñ—é–≤–∞–Ω–Ω—è"],
          status:"InProgress",
          percent:58,
          prev:"–í–∏—Ä—ñ–∑–∞–Ω–Ω—è —Ü–∏—Ñ–µ—Ä–±–ª–∞—Ç–∞",
          current:"–ó–±—ñ—Ä–∫–∞ —Ü–∏—Ñ–µ—Ä–±–ª–∞—Ç–∞",
          next:"–ö–æ–Ω—Ç—Ä–æ–ª—å —è–∫–æ—Å—Ç—ñ —Ü–∏—Ñ–µ—Ä–±–ª–∞—Ç–∞"
        }
      ]
    };

    // ===== HELPERS =====
    const $ = (id) => document.getElementById(id);

    const statusToPill = (s) => ({
      Done: ["done","–í–∏–∫–æ–Ω–∞–Ω–æ"],
      InProgress: ["progress","–£ —Ä–æ–±–æ—Ç—ñ"],
      NotStarted: ["todo","–ù–µ —Å—Ç–∞—Ä—Ç"],
      Blocked: ["blocked","–ó–∞–±–ª–æ–∫–æ–≤–∞–Ω–æ"],
      Rework: ["rework","–ü–µ—Ä–µ—Ä–æ–±–∫–∞"],
    }[s] || ["todo","‚Äî"]);

    function pickOrderStage(lineItems){
      // –ü—Ä–æ—Å—Ç–∞ –ª–æ–≥—ñ–∫–∞:
      // 1) —è–∫—â–æ —î Rework ‚Üí –ø–æ–∫–∞–∑—É—î–º–æ Rework current
      // 2) —è–∫—â–æ —î InProgress ‚Üí –ø–æ–∫–∞–∑—É—î–º–æ current (–ø–µ—Ä—à–∏–π –∞–±–æ –Ω–∞–π—á–∞—Å—Ç—ñ—à–∏–π)
      // 3) —è–∫—â–æ –≤—Å–µ Done ‚Üí "–ó–∞–≤–µ—Ä—à–µ–Ω–æ"
      const re = lineItems.find(x=>x.status==="Rework");
      if(re) return {label: re.current, kind:"rework"};

      const ip = lineItems.filter(x=>x.status==="InProgress");
      if(ip.length){
        // —è–∫—â–æ –∫—ñ–ª—å–∫–∞ ‚Äî –ø–æ–∫–∞–∂–µ–º–æ –ø–µ—Ä—à–∏–π, –∞ —É –ø—Ä–∞–≤—ñ–π –ø–∞–Ω–µ–ª—ñ –Ω–∞–ø–∏—à–µ–º–æ "–∫—ñ–ª—å–∫–∞ –ø–æ–∑–∏—Ü—ñ–π"
        return {label: ip[0].current, kind:"progress", multi: ip.length>1, count: ip.length};
      }

      const bl = lineItems.find(x=>x.status==="Blocked");
      if(bl) return {label: bl.current || "–û—á—ñ–∫—É—î", kind:"blocked"};

      const allDone = lineItems.length && lineItems.every(x=>x.status==="Done");
      if(allDone) return {label:"–ó–∞–≤–µ—Ä—à–µ–Ω–æ", kind:"done"};

      return {label:"–ù–µ —Ä–æ–∑–ø–æ—á–∞—Ç–æ", kind:"todo"};
    }

    function stageStatusFromItems(stageName, lineItems){
      // –í–∏–∑–Ω–∞—á–∞—î–º–æ —Å—Ç–∞—Ç—É—Å —Å—Ç–∞–¥—ñ—ó –ø–æ items:
      // - —è–∫—â–æ stage == current —ñ —Å—Ç–∞—Ç—É—Å InProgress ‚Üí stage InProgress (active)
      // - —è–∫—â–æ stage == current —ñ —Å—Ç–∞—Ç—É—Å Rework/Blocked ‚Üí –≤—ñ–¥–ø–æ–≤—ñ–¥–Ω–æ
      // - —è–∫—â–æ stage == prev –¥–ª—è item Done/InProgress ‚Üí Done
      // - —ñ–Ω–∞–∫—à–µ todo
      let hasActive = null; // [kind, isActive]
      let doneCount = 0;

      for(const li of lineItems){
        if(li.current === stageName){
          if(li.status === "InProgress") hasActive = ["progress", true];
          if(li.status === "Rework") hasActive = ["rework", true];
          if(li.status === "Blocked") hasActive = ["blocked", true];
        }
        if(li.prev === stageName){
          doneCount++;
        }
        // —è–∫—â–æ item Done —ñ –π–æ–≥–æ current —É —Ñ—ñ–Ω–∞–ª—ñ ‚Äî –ø–æ–ø–µ—Ä–µ–¥–Ω—ñ —Å—Ç–∞–¥—ñ—ó —Ç–µ–∂ –º–æ–∂–µ–º–æ –≤–≤–∞–∂–∞—Ç–∏ done
        // (—Å–ø—Ä–æ—â–µ–Ω–æ: –Ω–µ —Ä–æ–∑–≥–æ—Ä—Ç–∞—î–º–æ —ñ—Å—Ç–æ—Ä—ñ—é, —Ç–æ–º—É —Ü—å–æ–≥–æ –¥–æ—Å–∏—Ç—å –¥–ª—è –≤—ñ–∑—É–∞–ª—É)
      }

      if(hasActive) return {kind: hasActive[0], active: hasActive[1]};
      if(doneCount>0) return {kind:"done", active:false};
      return {kind:"todo", active:false};
    }

    function render(data){
      // Header
      $("orderId").textContent = data.order.external_order_id;

      $("orderMeta").innerHTML = `
        <span>üóìÔ∏è –°—Ç–≤–æ—Ä–µ–Ω–æ: <b>${data.order.created_at}</b></span>
        <span>‚è≥ –î–µ–¥–ª–∞–π–Ω: <b>${data.order.deadline}</b></span>
        <span>üë§ –ö–ª—ñ—î–Ω—Ç: <b>${data.order.customer}</b></span>
      `;

      // Sync
      const sync = data.order.sync_status;
      let syncTxt="Sync: ‚Äî", syncCls="pill";
      if(sync==="OK"){ syncTxt="Sync: OK"; syncCls="pill done"; }
      if(sync==="WARN"){ syncTxt="Sync: WARN"; syncCls="pill blocked"; }
      if(sync==="ERROR"){ syncTxt="Sync: ERROR"; syncCls="pill rework"; }
      $("syncPill").className = syncCls;
      $("syncPill").textContent = syncTxt;

      // Progress
      $("orderProgressBar").style.width = `${data.order.progress}%`;
      $("orderProgressText").textContent = `${data.order.progress}%`;

      // Order current stage
      const picked = pickOrderStage(data.line_items);
      $("orderCurrentStage").textContent =
        picked.multi ? `${picked.label} (—É —Ä–æ–±–æ—Ç—ñ: ${picked.count} –ø–æ–∑–∏—Ü—ñ—ó)` : picked.label;

      // Overall status pill
      const overall =
        data.line_items.some(x=>x.status==="Rework") ? "Rework" :
        data.line_items.some(x=>x.status==="Blocked") && !data.line_items.some(x=>x.status==="InProgress") ? "Blocked" :
        data.line_items.some(x=>x.status==="InProgress") ? "InProgress" :
        data.line_items.every(x=>x.status==="Done") ? "Done" : "NotStarted";

      const [pillClass, pillText] = statusToPill(overall);
      $("orderStatusPill").className = `pill ${pillClass}`;
      $("orderStatusPill").textContent = pillText;

      // Timeline
      const tl = $("timeline");
      tl.innerHTML = "";
      data.workflowStages.forEach(stage=>{
        const st = stageStatusFromItems(stage, data.line_items);
        const el = document.createElement("div");
        el.className = `stage ${st.kind} ${st.active ? "active":""}`;
        el.innerHTML = `
          <div class="dot" aria-hidden="true"></div>
          <div>
            <div class="name">${stage}</div>
            <div class="sub">${labelByKind(st.kind, st.active)}</div>
          </div>
        `;
        tl.appendChild(el);
      });

      // Items
      const itemsWrap = $("items");
      itemsWrap.innerHTML = "";
      let done=0, prog=0, todo=0, risk=0;

      data.line_items.forEach(li=>{
        if(li.status==="Done") done++;
        if(li.status==="InProgress") prog++;
        if(li.status==="NotStarted") todo++;
        if(li.status==="Blocked" || li.status==="Rework") risk++;

        const [cls, txt] = statusToPill(li.status);

        const item = document.createElement("div");
        item.className = "item";
        item.innerHTML = `
          <div class="img" title="Attachment / —ñ–∫–æ–Ω–∫–∞">${li.icon || "üß©"}</div>

          <div>
            <div class="title">${escapeHtml(li.title)}</div>
            <div class="desc">
              <span>SKU: <b>${escapeHtml(li.sku)}</b></span>
              <span>–ö-—Å—Ç—å: <b>${li.qty}</b></span>
              <span class="pill ${cls}">${txt}</span>
            </div>
            <div class="kv" style="margin-top:8px;">
              <span><b>Previous:</b> ${escapeHtml(li.prev || "‚Äî")}</span>
              <span><b>Current:</b> ${escapeHtml(li.current || "‚Äî")}</span>
              <span><b>Next:</b> ${escapeHtml(li.next || "‚Äî")}</span>
            </div>
            ${li.tags?.length ? `<div class="kv" style="margin-top:8px;">
              ${li.tags.map(t=>`<span class="pill">${escapeHtml(t)}</span>`).join("")}
            </div>` : ""}
          </div>

          <div class="right">
            <div class="muted small">–ü—Ä–æ–≥—Ä–µ—Å</div>
            <div class="miniBar"><div style="width:${li.percent || 0}%"></div></div>
            <div class="muted small">${li.percent || 0}%</div>
          </div>
        `;
        itemsWrap.appendChild(item);
      });

      $("itemsSummary").textContent = `–í—Å—å–æ–≥–æ: ${data.line_items.length} ‚Ä¢ –£ —Ä–æ–±–æ—Ç—ñ: ${prog} ‚Ä¢ –†–∏–∑–∏–∫–∏: ${risk}`;

      // Manager panel
      $("stDone").textContent = done;
      $("stProg").textContent = prog;
      $("stTodo").textContent = todo;
      $("stRisk").textContent = risk;

      const calloutText = makeCallout(data, picked, overall);
      $("callout").textContent = calloutText.title;
      $("calloutHint").textContent = calloutText.hint;

      // Risks list
      const r = $("risks");
      r.innerHTML = "";
      const rows = [];

      if(risk===0) rows.push({icon:"‚úÖ", text:"–ö—Ä–∏—Ç–∏—á–Ω–∏—Ö —Ä–∏–∑–∏–∫—ñ–≤ –Ω–µ –≤–∏—è–≤–ª–µ–Ω–æ"});
      if(data.line_items.some(x=>x.status==="Rework")) rows.push({icon:"üî¥", text:"–Ñ –ø–æ–∑–∏—Ü—ñ—ó –Ω–∞ –ø–µ—Ä–µ—Ä–æ–±—Ü—ñ (Rework)"});
      if(data.line_items.some(x=>x.status==="Blocked")) rows.push({icon:"üü†", text:"–Ñ –∑–∞–±–ª–æ–∫–æ–≤–∞–Ω—ñ –ø–æ–∑–∏—Ü—ñ—ó (Blocked) ‚Äî –ø–æ—Ç—Ä—ñ–±–Ω–∞ –¥—ñ—è"});
      if(data.order.sync_status==="WARN") rows.push({icon:"‚ö†Ô∏è", text:"–ü–æ–ø–µ—Ä–µ–¥–∂–µ–Ω–Ω—è —Å–∏–Ω—Ö—Ä–æ–Ω—ñ–∑–∞—Ü—ñ—ó (Sync WARN)"});
      if(data.order.sync_status==="ERROR") rows.push({icon:"‚ùó", text:"–ü–æ–º–∏–ª–∫–∞ —Å–∏–Ω—Ö—Ä–æ–Ω—ñ–∑–∞—Ü—ñ—ó (Sync ERROR)"});
      if(prog>1) rows.push({icon:"‚ÑπÔ∏è", text:`–ü–∞—Ä–∞–ª–µ–ª—å–Ω–æ –≤ —Ä–æ–±–æ—Ç—ñ ${prog} –ø–æ–∑–∏—Ü—ñ—ó ‚Äî –Ω–µ –æ–¥–Ω–∞ —Å—Ç–∞–¥—ñ—è`});

      rows.forEach(x=>{
        const div = document.createElement("div");
        div.className = "row";
        div.innerHTML = `<span style="font-size:18px">${x.icon}</span><div><strong>${escapeHtml(x.text)}</strong></div>`;
        r.appendChild(div);
      });
    }

    function labelByKind(kind, active){
      if(active) return "–ê–∫—Ç–∏–≤–Ω–∞";
      if(kind==="done") return "–í–∏–∫–æ–Ω–∞–Ω–æ";
      if(kind==="progress") return "–£ —Ä–æ–±–æ—Ç—ñ";
      if(kind==="blocked") return "–ë–ª–æ–∫";
      if(kind==="rework") return "–ü–µ—Ä–µ—Ä–æ–±–∫–∞";
      return "–û—á—ñ–∫—É—î";
    }

    function makeCallout(data, picked, overall){
      if(overall==="Done"){
        return {
          title: `–ó–∞–º–æ–≤–ª–µ–Ω–Ω—è –∑–∞–≤–µ—Ä—à–µ–Ω–æ ‚úÖ`,
          hint: `–£—Å—ñ –ø–æ–∑–∏—Ü—ñ—ó –≤–∏–∫–æ–Ω–∞–Ω—ñ. –ú–æ–∂–Ω–∞ –ø–æ–≤—ñ–¥–æ–º–ª—è—Ç–∏ –∫–ª—ñ—î–Ω—Ç–∞ –ø—Ä–æ –≥–æ—Ç–æ–≤–Ω—ñ—Å—Ç—å/–≤—ñ–¥–ø—Ä–∞–≤–∫—É.`
        };
      }
      if(overall==="Rework"){
        return {
          title: `–Ñ –ø–µ—Ä–µ—Ä–æ–±–∫–∞ –Ω–∞ —Å—Ç–∞–¥—ñ—ó: ${picked.label}`,
          hint: `–°–∫–∞–∂—ñ—Ç—å –∫–ª—ñ—î–Ω—Ç—É: "–ù–∞ –≤–∏—Ä–æ–±–Ω–∏—Ü—Ç–≤—ñ —É—Ç–æ—á–Ω—é—î–º–æ –ø—Ä–∞–≤–∫–∏, –ø—ñ—Å–ª—è —Ü—å–æ–≥–æ –ø—ñ–¥–µ –¥–∞–ª—ñ –ø–æ –ø—Ä–æ—Ü–µ—Å—É".`
        };
      }
      if(overall==="Blocked"){
        return {
          title: `–û—á—ñ–∫—É—î –¥—ñ—é/–¥–µ—Ç–∞–ª—ñ –Ω–∞ —Å—Ç–∞–¥—ñ—ó: ${picked.label}`,
          hint: `–°–∫–∞–∂—ñ—Ç—å –∫–ª—ñ—î–Ω—Ç—É: "–Ñ –∑–∞—Ç—Ä–∏–º–∫–∞ —á–µ—Ä–µ–∑ –ø—Ä–æ—Ü–µ—Å/–º–∞—Ç–µ—Ä—ñ–∞–ª–∏, —É—Ç–æ—á–Ω—é—î–º–æ —Ç–µ—Ä–º—ñ–Ω".`
        };
      }
      return {
        title: `–ó–∞—Ä–∞–∑ –Ω–∞ –µ—Ç–∞–ø—ñ: ${picked.label}`,
        hint: data.line_items.filter(x=>x.status==="InProgress").length
          ? `–£ —Ä–æ–±–æ—Ç—ñ ${data.line_items.filter(x=>x.status==="InProgress").length} –ø–æ–∑–∏—Ü—ñ—è(—ó).`
          : `–û—á—ñ–∫—É—î —Å—Ç–∞—Ä—Ç—É –Ω–∞—Å—Ç—É–ø–Ω–∏—Ö –ø—Ä–æ—Ü–µ—Å—ñ–≤.`
      };
    }

    function escapeHtml(s){
      return String(s ?? "")
        .replaceAll("&","&amp;")
        .replaceAll("<","&lt;")
        .replaceAll(">","&gt;")
        .replaceAll('"',"&quot;")
        .replaceAll("'","&#039;");
    }

    // ===== Search mock =====
    function searchByExternalId(externalId){
      // –î–µ–º–æ: —è–∫—â–æ –≤–≤–µ–ª–∏ —â–æ—Å—å ‚Äî –ø–æ–∫–∞–∑—É—î–º–æ DEMO, –∞–ª–µ –ø—ñ–¥—Å—Ç–∞–≤–∏–º–æ external_order_id
      const clone = JSON.parse(JSON.stringify(DEMO));
      clone.order.external_order_id = externalId || DEMO.order.external_order_id;
      return clone;
    }

    $("btnSearch").addEventListener("click", ()=>{
      const id = $("q").value.trim();
      if(!id){
        alert("–í–≤–µ–¥—ñ—Ç—å external_order_id (–Ω–∞–ø—Ä–∏–∫–ª–∞–¥ O-AW-3918).");
        return;
      }
      render(searchByExternalId(id));
    });

    $("btnDemo").addEventListener("click", ()=>{
      $("q").value = DEMO.order.external_order_id;
      render(DEMO);
    });

    $("q").addEventListener("keydown",(e)=>{
      if(e.key==="Enter") $("btnSearch").click();
    });

    // –ê–≤—Ç–æ–∑–∞–ø—É—Å–∫ –¥–µ–º–æ
    render(DEMO);
  </script>
</body>
</html>
